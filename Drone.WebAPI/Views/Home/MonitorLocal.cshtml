@section styles {
    <link href="@Url.Content("~/Content/monitor.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/jqx.base.css")" rel="stylesheet" type="text/css" />
}

@section scripts{
    <!--Reference the autogenerated SignalR hub script. Script is loaded dynamically w/Jquery when creating the connections below -->
    @*    <script src="http://p3pwbidata02/BIData/signalr/hubs"></script>*@
    <script src="@Url.Content("~/Scripts/jquery.signalR-2.0.2.min.js")"></script>
    <!-- templating js -->
    <script src="@Url.Content("~/Scripts/mustache.js")" type="text/javascript"></script>
    <!-- jqx guages -->
    <script src="@Url.Content("~/Scripts/jqxcore.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jqxchart.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jqxgauge.js")" type="text/javascript"></script>
}

<!--Add script to update the page and send messages.-->
<script type="text/javascript">

    //gets the hub connections and starts (note, each proxy will be kept in an array for memorey reference)
    function GetHub(url) {
        //create connection to server
        var con = $.hubConnection("http://" + url + "/BIDataApi");
        //create proxy for this hub
        var monHub = con.createHubProxy('monitorHub');

        //late bind showStatus method for updating the UI (server will broadcast "showstatus")
        monHub.on('showStatus', function (data) {
            $('#' + url + '-box').html(Mustache.to_html($('#serviceTpl').html(), data));
            $('#gauge-' + url).jqxGauge('value', data.RequestRate);
            $('#gaugeCD-' + url).jqxGauge('value', data.CrawlDaddyRequestRate / 10);
            $('#gaugeQ-' + url).jqxLinearGauge('value', data.Queue.QueueCount);

            //these set the gauge color levels
            var fillColor = data.Queue.QueueCount > 150 ? "#e53d37" : data.Queue.QueueCount > 100 ? "#fad00b" : "#4cb848";
            $('#gaugeQ-' + url).jqxLinearGauge({ pointer: { pointerType: 'default', style: { fill: fillColor, stroke: fillColor }, width: '3%', visible: true, offset: -6 } });

            //set switches
            SetSwitches(data);
        });

        //call start, when finished starting late bind click event on a tags to call "send"
        con.start().done(function () {
            $('#' + url + '-box').on('click', 'a.command', function (sender) {
                monHub.invoke('send', $(this).attr('data-action'), $(this).attr('data-service'))
                .fail(function (error) {
                    alert(error);
                });
            });

            monHub.allqueues = function (action) {
                this.invoke('send', action, 'Drone.QueueProcessor.Service')
                .fail(function (error) {
                    alert(error);
                });
            };

            monHub.allcrawls = function (action) {
                this.invoke('send', action, 'Drone.CrawlDaddy.Service')
                .fail(function (error) {
                    alert(error);
                });
            };

        });

        return monHub;
    }

    function SetSwitches(data)
    {
        //check svcweb for queue processors for now
        if (data.ServiceBoxName.toLowerCase().indexOf("svcweb") != -1) {
            var result = true;
            $.each(data.DroneServices, function (idx, svc) {
                if (svc.ServiceShortName == 'QueueProcessor' && svc.Status == 'Stopped') {
                    result = false;
                }
            });
            $('#queueswitch').prop('checked', result);
        }

        if (data.ServiceBoxName.toLowerCase().indexOf("bidata") != -1) {
            result = true;
            $.each(data.DroneServices, function (idx, svc) {
                if (svc.ServiceShortName == 'CrawlDaddy' && svc.Status == 'Stopped') {
                    result = false
                }
            });
            $('#crawlswitch').attr('checked', result);
        }
    }

    //Call each hub to create connection and store in an array
    $(function () {
        var hubs = [];

        $('.box').each(function () {
            var serv = $(this).attr('data-server');
            //loads the js into memory
            $.getScript('http://' + serv + '/BIDataApi/signalr/hubs');
            //push the hub onto array to store in memory
            hubs.push(GetHub(serv));
        });

        $('.gauge').each(function () {
            var serv = $(this).attr('data-server');
            $('#gauge-' + serv).jqxGauge({
                ranges: [{ startValue: 0, endValue: 2, style: { fill: '#e53d37', stroke: '#e53d37' }, startDistance: 0, endDistance: 0 },
                         { startValue: 2, endValue: 4, style: { fill: '#fad00b', stroke: '#fad00b' }, startDistance: 0, endDistance: 0 },
                         { startValue: 4, endValue: 50, style: { fill: '#4cb848', stroke: '#4cb848' }, startDistance: 0, endDistance: 0 }],
                cap: { size: '10%', style: { fill: '#2e79bb', stroke: '#2e79bb' } },
                border: { style: { fill: '#8e9495', stroke: '#7b8384', 'stroke-width': 1 } },
                ticksMinor: { interval: 5, size: '5%' },
                ticksMajor: { interval: 10, size: '10%' },
                labels: { position: 'outside', interval: 10 },
                pointer: { style: { fill: '#2e79bb' }, width: 3 },
                animationDuration: 0,
                max: 50,
                caption: { value: 'API /sec', position: 'bottom', offset: [0, 1], visible: true },
                width: '105',
                height: '105',
                radius: '51%'
            });
        });

        $('.gaugeQ').each(function () {
            var serv = $(this).attr('data-server');
            $('#gaugeQ-' + serv).jqxLinearGauge({
                ranges: [{ startValue: 0, endValue: 200, }],
                ticksMinor: { interval: 25, size: '5%' },
                ticksMajor: { interval: 50, size: '10%', style: { stroke: '#A1A1A1', 'stroke-width': 1 }, visibile: true },
                labels: { position: 'both', interval: 50, offset: 0 },
                pointer: { style: { fill: '#2e79bb' }, width: 3 },
                animationDuration: 750,
                max: 200,
                min: 0,
                width: '75%',
                height: '100',
                background: { showGradient: true, borderRadius: 5, visible: false, backgroundType: 'roundedRectangle' },
                pointer: { pointerType: 'default', style: { fill: '#4cb848', stroke: '#4cb848' }, width: '3%', visible: true, offset: -6 },
            });
        });

        $('.gaugeCD').each(function () {
            var serv = $(this).attr('data-server');
            $('#gaugeCD-' + serv).jqxGauge({
                ranges: [{ startValue: 0, endValue: 10, style: { fill: '#e53d37', stroke: '#e53d37' }, startDistance: 0, endDistance: 0 },
                         { startValue: 10, endValue: 20, style: { fill: '#fad00b', stroke: '#fad00b' }, startDistance: 0, endDistance: 0 },
                         { startValue: 20, endValue: 50, style: { fill: '#4cb848', stroke: '#4cb848' }, startDistance: 0, endDistance: 0 }],
                cap: { size: '10%', style: { fill: '#2e79bb', stroke: '#2e79bb' } },
                border: { style: { fill: '#8e9495', stroke: '#7b8384', 'stroke-width': 1 } },
                ticksMinor: { interval: 5, size: '5%' },
                ticksMajor: { interval: 10, size: '10%' },
                labels: { position: 'outside', interval: 10 },
                pointer: { style: { fill: '#2e79bb' }, width: 3 },
                animationDuration: 0,
                max: 50,
                caption: { value: 'CD/min*10', position: 'bottom', offset: [0, 1], visible: true },
                width: '105',
                height: '105',
                radius: '51%'
            });
        });

        $('#queueswitch').click(function () {
            var action = $(this).prop('checked') ? 'start' : 'stop';
            $.each(hubs, function (i, hub) {
                if (i < 4)
                    hub.allqueues(action);
            });
        });

        $('#crawlswitch').click(function () {
            var action = $(this).prop('checked') ? 'start' : 'stop';
            $.each(hubs, function (i, hub) {
                if (i > 3)
                    hub.allcrawls(action);
            });
        });
    });

    
</script>

<!-- main content layout containers -->
<div id="main_content">
    <section class="header">
        <hgroup>
            <h1>BI Data Service and Queue Info</h1>
            <p>
                <br />
            </p>
        </hgroup>
    </section>
    <section class="content_section">
        <table cellpadding="0" cellspacing="0">
            <tr>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
                <td>
                    <div class="box" id="localhost-box" data-server="localhost">
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="svc_light">
                        <div class="insetdiv">
                            <table>
                                <tr>
                                    <td style="width: 129px;">
                                        <div id="gauge-localhost" class="gauge" data-server="localhost"></div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeQ-localhost" class="gaugeQ" data-server="localhost"></div>
                                        <div class="gaugelabel">Queue Count</div>
                                    </td>
                                    <td style="width: 129px;">
                                        <div id="gaugeCD-localhost" class="gaugeCD" data-server="localhost"></div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="4">
                    <div class="adminbox">
                        <div class="insetdiv">
                            <center>
                        <table>
                            <tr><td colspan="2" style="text-align:center;">KILL SWITCHES</td></tr>
                            <tr>
                                <td>
                                    <div class="onoffswitch">
                                        <input type="checkbox" name="queueswitch" class="onoffswitch-checkbox" id="queueswitch">
                                        <label class="onoffswitch-label" for="queueswitch">
                                            <div class="onoffswitch-inner"></div>
                                            <div class="onoffswitch-switch"></div>
                                        </label>
                                    </div>
                                    <div>&nbsp;&nbsp;Queues</div>
                                </td>
                                <td>
                                    <div class="onoffswitch">
                                        <input type="checkbox" name="crawlswitch" class="onoffswitch-checkbox" id="crawlswitch" checked>
                                        <label class="onoffswitch-label" for="crawlswitch">
                                            <div class="onoffswitch-inner"></div>
                                            <div class="onoffswitch-switch"></div>
                                        </label>
                                    </div>
                                    <div>&nbsp;&nbsp;Crawlers</div>
                                </td>
                            </tr>
                        </table>
                                </center>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </section>
</div>

<!-- template for content -->
<script id="serviceTpl" type="text/template">
    <div class="title" style="text-align: center;">
        <h1><a href="file://{{ServiceBoxName}}/d$/bizintel.webservices.gdg/BIData/Logs" target="_blank">{{ServiceBoxName}}</a></h1>
    </div>
    <div class="clear">
        <div id="serverdiv" class="svc_header {{Queue.HasErrors}}">
            <div class="insetdiv">
                <table style="width: 99%;">
                    <tr>
                        <td class="title b" style="width: 220px;">Service</td>
                        <td class="title b" style="text-align: center;">State</td>
                        <td class="title b" style="width: 50px;">Command</td>
                    </tr>
                    {{#DroneServices}}
                <tr class="{{Status}} {{HasError}}">
                    <td style="width: 220px; padding: 3px;">
                        <a href="file://{{ServiceBoxName}}/d$/bizintel.webservices.gdg/Drone/{{ServiceShortName}}/Logs" target="_blank">{{ServiceShortName}}</a>
                    </td>
                    <td style="text-align: center;">{{Status}}
                    </td>
                    <td style="text-align: center; width: 50px; padding: 3px;">
                        <a href="#" class="command" data-action="{{StatusAction}}" data-service="{{ServiceName}}">{{StatusAction}}</a>
                    </td>
                </tr>
                    {{/DroneServices}}
                <tr>
                    <td colspan="3">
                        <div>
                            <div id="detailsdiv-{{ServiceBoxName}}">
                                <hr />
                                <span class="title b">Drone Queue Count: </span><span class="title" id="{{ServiceBoxName}}-count">{{Queue.QueueCount}}</span>
                                <br />
                                <span class="title b">API Request Count: </span><span class="title" id="{{ServiceBoxName}}-reqcount">{{RequestCount}}</span>
                                <br />
                                <span class="title b">CD Complete Count: </span><span class="title" id="{{ServiceBoxName}}-cdreqcount">{{CrawlDaddyRequestCount}}</span>
                                <br />
                                <span class="title b">CD Complete Rate: </span><span class="title" id="{{ServiceBoxName}}-cdreqrate">{{CrawlDaddyRequestRate}} /min</span>
                                <br />
                            </div>
                        </div>
                    </td>
                </tr>
                </table>
            </div>
        </div>
    </div>
</script>
